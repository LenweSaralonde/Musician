!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("MusicianMidiConverter",[],t):"object"==typeof exports?exports.MusicianMidiConverter=t():e.MusicianMidiConverter=t()}(this,(()=>(()=>{var e={473:(e,t,r)=>{t.parseMidi=r(650),r(772)},650:e=>{function t(e){for(var t,n=new r(e),a=[];!n.eof();){var i=o();a.push(i)}return a;function o(){var e={};e.deltaTime=n.readVarInt();var r=n.readUInt8();if(240==(240&r)){if(255!==r){if(240==r)return e.type="sysEx",i=n.readVarInt(),e.data=n.readBytes(i),e;if(247==r)return e.type="endSysEx",i=n.readVarInt(),e.data=n.readBytes(i),e;throw"Unrecognised MIDI event type byte: "+r}e.meta=!0;var a=n.readUInt8(),i=n.readVarInt();switch(a){case 0:if(e.type="sequenceNumber",2!==i)throw"Expected length for sequenceNumber event is 2, got "+i;return e.number=n.readUInt16(),e;case 1:return e.type="text",e.text=n.readString(i),e;case 2:return e.type="copyrightNotice",e.text=n.readString(i),e;case 3:return e.type="trackName",e.text=n.readString(i),e;case 4:return e.type="instrumentName",e.text=n.readString(i),e;case 5:return e.type="lyrics",e.text=n.readString(i),e;case 6:return e.type="marker",e.text=n.readString(i),e;case 7:return e.type="cuePoint",e.text=n.readString(i),e;case 32:if(e.type="channelPrefix",1!=i)throw"Expected length for channelPrefix event is 1, got "+i;return e.channel=n.readUInt8(),e;case 33:if(e.type="portPrefix",1!=i)throw"Expected length for portPrefix event is 1, got "+i;return e.port=n.readUInt8(),e;case 47:if(e.type="endOfTrack",0!=i)throw"Expected length for endOfTrack event is 0, got "+i;return e;case 81:if(e.type="setTempo",3!=i)throw"Expected length for setTempo event is 3, got "+i;return e.microsecondsPerBeat=n.readUInt24(),e;case 84:if(e.type="smpteOffset",5!=i)throw"Expected length for smpteOffset event is 5, got "+i;var o=n.readUInt8();return e.frameRate={0:24,32:25,64:29,96:30}[96&o],e.hour=31&o,e.min=n.readUInt8(),e.sec=n.readUInt8(),e.frame=n.readUInt8(),e.subFrame=n.readUInt8(),e;case 88:if(e.type="timeSignature",2!=i&&4!=i)throw"Expected length for timeSignature event is 4 or 2, got "+i;return e.numerator=n.readUInt8(),e.denominator=1<<n.readUInt8(),4===i?(e.metronome=n.readUInt8(),e.thirtyseconds=n.readUInt8()):(e.metronome=36,e.thirtyseconds=8),e;case 89:if(e.type="keySignature",2!=i)throw"Expected length for keySignature event is 2, got "+i;return e.key=n.readInt8(),e.scale=n.readUInt8(),e;case 127:return e.type="sequencerSpecific",e.data=n.readBytes(i),e;default:return e.type="unknownMeta",e.data=n.readBytes(i),e.metatypeByte=a,e}}else{var c;if(0==(128&r)){if(null===t)throw"Running status byte encountered before status byte";c=r,r=t,e.running=!0}else c=n.readUInt8(),t=r;var u=r>>4;switch(e.channel=15&r,u){case 8:return e.type="noteOff",e.noteNumber=c,e.velocity=n.readUInt8(),e;case 9:var l=n.readUInt8();return e.type=0===l?"noteOff":"noteOn",e.noteNumber=c,e.velocity=l,0===l&&(e.byte9=!0),e;case 10:return e.type="noteAftertouch",e.noteNumber=c,e.amount=n.readUInt8(),e;case 11:return e.type="controller",e.controllerType=c,e.value=n.readUInt8(),e;case 12:return e.type="programChange",e.programNumber=c,e;case 13:return e.type="channelAftertouch",e.amount=c,e;case 14:return e.type="pitchBend",e.value=c+(n.readUInt8()<<7)-8192,e;default:throw"Unrecognised MIDI event type: "+u}}}}function r(e){this.buffer=e,this.bufferLen=this.buffer.length,this.pos=0}r.prototype.eof=function(){return this.pos>=this.bufferLen},r.prototype.readUInt8=function(){var e=this.buffer[this.pos];return this.pos+=1,e},r.prototype.readInt8=function(){var e=this.readUInt8();return 128&e?e-256:e},r.prototype.readUInt16=function(){return(this.readUInt8()<<8)+this.readUInt8()},r.prototype.readInt16=function(){var e=this.readUInt16();return 32768&e?e-65536:e},r.prototype.readUInt24=function(){return(this.readUInt8()<<16)+(this.readUInt8()<<8)+this.readUInt8()},r.prototype.readInt24=function(){var e=this.readUInt24();return 8388608&e?e-16777216:e},r.prototype.readUInt32=function(){return(this.readUInt8()<<24)+(this.readUInt8()<<16)+(this.readUInt8()<<8)+this.readUInt8()},r.prototype.readBytes=function(e){var t=this.buffer.slice(this.pos,this.pos+e);return this.pos+=e,t},r.prototype.readString=function(e){var t=this.readBytes(e),r=(new TextDecoder).decode(t),n=String.fromCharCode.apply(null,t);return n.length>r.length?r:n},r.prototype.readVarInt=function(){for(var e=0;!this.eof();){var t=this.readUInt8();if(!(128&t))return e+t;e+=127&t,e<<=7}return e},r.prototype.readChunk=function(){var e=this.readString(4),t=this.readUInt32();return{id:e,length:t,data:this.readBytes(t)}},e.exports=function(e){var n=new r(e),a=n.readChunk();if("MThd"!=a.id)throw"Bad MIDI file.  Expected 'MHdr', got: '"+a.id+"'";for(var i=function(e){var t=new r(e),n={format:t.readUInt16(),numTracks:t.readUInt16()},a=t.readUInt16();return 32768&a?(n.framesPerSecond=256-(a>>8),n.ticksPerFrame=255&a):n.ticksPerBeat=a,n}(a.data),o=[],c=0;!n.eof()&&c<i.numTracks;c++){var u=n.readChunk();if("MTrk"!=u.id)throw"Bad MIDI file.  Expected 'MTrk', got: '"+u.id+"'";var l=t(u.data);o.push(l)}return{header:i,tracks:o}}},772:e=>{function t(e){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},t(e)}function r(e,t,r){var i,o=new a,c=t.length,u=null;for(i=0;i<c;i++)!1!==r.running&&(r.running||t[i].running)||(u=null),u=n(o,t[i],u,r.useByte9ForNoteOff);e.writeChunk("MTrk",o.buffer)}function n(e,t,r,n){var a=t.type,i=t.deltaTime,o=t.text||"",c=t.data||[],u=null;switch(e.writeVarInt(i),a){case"sequenceNumber":e.writeUInt8(255),e.writeUInt8(0),e.writeVarInt(2),e.writeUInt16(t.number);break;case"text":e.writeUInt8(255),e.writeUInt8(1),e.writeVarInt(o.length),e.writeString(o);break;case"copyrightNotice":e.writeUInt8(255),e.writeUInt8(2),e.writeVarInt(o.length),e.writeString(o);break;case"trackName":e.writeUInt8(255),e.writeUInt8(3),e.writeVarInt(o.length),e.writeString(o);break;case"instrumentName":e.writeUInt8(255),e.writeUInt8(4),e.writeVarInt(o.length),e.writeString(o);break;case"lyrics":e.writeUInt8(255),e.writeUInt8(5),e.writeVarInt(o.length),e.writeString(o);break;case"marker":e.writeUInt8(255),e.writeUInt8(6),e.writeVarInt(o.length),e.writeString(o);break;case"cuePoint":e.writeUInt8(255),e.writeUInt8(7),e.writeVarInt(o.length),e.writeString(o);break;case"channelPrefix":e.writeUInt8(255),e.writeUInt8(32),e.writeVarInt(1),e.writeUInt8(t.channel);break;case"portPrefix":e.writeUInt8(255),e.writeUInt8(33),e.writeVarInt(1),e.writeUInt8(t.port);break;case"endOfTrack":e.writeUInt8(255),e.writeUInt8(47),e.writeVarInt(0);break;case"setTempo":e.writeUInt8(255),e.writeUInt8(81),e.writeVarInt(3),e.writeUInt24(t.microsecondsPerBeat);break;case"smpteOffset":e.writeUInt8(255),e.writeUInt8(84),e.writeVarInt(5);var l=31&t.hour|{24:0,25:32,29:64,30:96}[t.frameRate];e.writeUInt8(l),e.writeUInt8(t.min),e.writeUInt8(t.sec),e.writeUInt8(t.frame),e.writeUInt8(t.subFrame);break;case"timeSignature":e.writeUInt8(255),e.writeUInt8(88),e.writeVarInt(4),e.writeUInt8(t.numerator);var s=255&Math.floor(Math.log(t.denominator)/Math.LN2);e.writeUInt8(s),e.writeUInt8(t.metronome),e.writeUInt8(t.thirtyseconds||8);break;case"keySignature":e.writeUInt8(255),e.writeUInt8(89),e.writeVarInt(2),e.writeInt8(t.key),e.writeUInt8(t.scale);break;case"sequencerSpecific":e.writeUInt8(255),e.writeUInt8(127),e.writeVarInt(c.length),e.writeBytes(c);break;case"unknownMeta":null!=t.metatypeByte&&(e.writeUInt8(255),e.writeUInt8(t.metatypeByte),e.writeVarInt(c.length),e.writeBytes(c));break;case"sysEx":e.writeUInt8(240),e.writeVarInt(c.length),e.writeBytes(c);break;case"endSysEx":e.writeUInt8(247),e.writeVarInt(c.length),e.writeBytes(c);break;case"noteOff":(u=(!1!==n&&t.byte9||n&&0==t.velocity?144:128)|t.channel)!==r&&e.writeUInt8(u),e.writeUInt8(t.noteNumber),e.writeUInt8(t.velocity);break;case"noteOn":(u=144|t.channel)!==r&&e.writeUInt8(u),e.writeUInt8(t.noteNumber),e.writeUInt8(t.velocity);break;case"noteAftertouch":(u=160|t.channel)!==r&&e.writeUInt8(u),e.writeUInt8(t.noteNumber),e.writeUInt8(t.amount);break;case"controller":(u=176|t.channel)!==r&&e.writeUInt8(u),e.writeUInt8(t.controllerType),e.writeUInt8(t.value);break;case"programChange":(u=192|t.channel)!==r&&e.writeUInt8(u),e.writeUInt8(t.programNumber);break;case"channelAftertouch":(u=208|t.channel)!==r&&e.writeUInt8(u),e.writeUInt8(t.amount);break;case"pitchBend":(u=224|t.channel)!==r&&e.writeUInt8(u);var f=8192+t.value,h=127&f,p=f>>7&127;e.writeUInt8(h),e.writeUInt8(p);break;default:throw"Unrecognized event type: "+a}return u}function a(){this.buffer=[]}a.prototype.writeUInt8=function(e){this.buffer.push(255&e)},a.prototype.writeInt8=a.prototype.writeUInt8,a.prototype.writeUInt16=function(e){var t=e>>8&255,r=255&e;this.writeUInt8(t),this.writeUInt8(r)},a.prototype.writeInt16=a.prototype.writeUInt16,a.prototype.writeUInt24=function(e){var t=e>>16&255,r=e>>8&255,n=255&e;this.writeUInt8(t),this.writeUInt8(r),this.writeUInt8(n)},a.prototype.writeInt24=a.prototype.writeUInt24,a.prototype.writeUInt32=function(e){var t=e>>24&255,r=e>>16&255,n=e>>8&255,a=255&e;this.writeUInt8(t),this.writeUInt8(r),this.writeUInt8(n),this.writeUInt8(a)},a.prototype.writeInt32=a.prototype.writeUInt32,a.prototype.writeBytes=function(e){this.buffer=this.buffer.concat(Array.prototype.slice.call(e,0))},a.prototype.writeString=function(e){var t,r=e.length,n=[];for(t=0;t<r;t++)n.push(e.codePointAt(t));this.writeBytes(n)},a.prototype.writeVarInt=function(e){if(e<0)throw"Cannot write negative variable-length integer";if(e<=127)this.writeUInt8(e);else{var t=e,r=[];for(r.push(127&t),t>>=7;t;){var n=127&t|128;r.push(n),t>>=7}this.writeBytes(r.reverse())}},a.prototype.writeChunk=function(e,t){this.writeString(e),this.writeUInt32(t.length),this.writeBytes(t)},e.exports=function(e,n){if("object"!==t(e))throw"Invalid MIDI data";n=n||{};var i,o=e.header||{},c=e.tracks||[],u=c.length,l=new a;for(function(e,t,r){var n=null==t.format?1:t.format,i=128;t.timeDivision?i=t.timeDivision:t.ticksPerFrame&&t.framesPerSecond?i=-(255&t.framesPerSecond)<<8|255&t.ticksPerFrame:t.ticksPerBeat&&(i=32767&t.ticksPerBeat);var o=new a;o.writeUInt16(n),o.writeUInt16(r),o.writeUInt16(i),e.writeChunk("MThd",o.buffer)}(l,o,u),i=0;i<u;i++)r(l,c[i],n);return l.buffer}}},t={};function r(n){var a=t[n];if(void 0!==a)return a.exports;var i=t[n]={exports:{}};return e[n](i,i.exports,r),i.exports}r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var n={};return(()=>{"use strict";function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}function t(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,a,i,o,c=[],u=!0,l=!1;try{if(i=(r=r.call(e)).next,0===t){if(Object(r)!==r)return;u=!1}else for(;!(u=(n=i.call(r)).done)&&(c.push(n.value),c.length!==t);u=!0);}catch(e){l=!0,a=e}finally{try{if(!u&&null!=r.return&&(o=r.return(),Object(o)!==o))return}finally{if(l)throw a}}return c}}(e,t)||c(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function a(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function i(t){for(var r=1;r<arguments.length;r++){var n=null!=arguments[r]?arguments[r]:{};r%2?a(Object(n),!0).forEach((function(r){var a,i,o,c;a=t,i=r,o=n[r],c=function(t,r){if("object"!=e(t)||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var a=n.call(t,"string");if("object"!=e(a))return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(i),(i="symbol"==e(c)?c:String(c))in a?Object.defineProperty(a,i,{value:o,enumerable:!0,configurable:!0,writable:!0}):a[i]=o})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function o(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=c(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,o=!0,u=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return o=e.done,e},e:function(e){u=!0,i=e},f:function(){try{o||null==r.return||r.return()}finally{if(u)throw i}}}}function c(e,t){if(e){if("string"==typeof e)return u(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?u(e,t):void 0}}function u(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}r.r(n),r.d(n,{CONVERTER_VERSION:()=>s,packSong:()=>S});var l=r(473).parseMidi,s="8.8",f="MUS8",h=42.5,p=1530,y=240,d=65535/y,I=16,m=2,w=12,v=100,b=101,U=6,g=38;function k(e,t){e&=Math.pow(256,t)-1;for(var r="",n=0;n<t;n++)r=String.fromCharCode(255&e)+r,e>>=8;return r}function x(e){var t=function(e){return unescape(encodeURIComponent(e)).replace(/\u0000+$/,"")}(e);return k(t.length,2)+t}function S(e,r,n){var a=function(e,r,n){e instanceof ArrayBuffer&&(e=new Uint8Array(e));var a,c=l(e),u=function(e){var r,n=[],a=new Map,c=new Map,u={},l=o(e);try{for(l.s();!(r=l.n()).done;){var s=r.value;if("noteOn"===s.type||"noteOff"===s.type){var f="".concat(s.channel,"-").concat(s.trackIndex,"-").concat(s.noteNumber);if("noteOn"===s.type){a.set(f,s);var h=c.get(f);h&&(n.push({deltaTime:s.deltaTime,tick:s.tick,time:s.time,channel:h.channel,noteNumber:h.noteNumber,trackIndex:h.trackIndex,type:"noteOff",velocity:h.velocity}),c.delete(f)),n.push(i({},s))}else a.delete(f),u[s.channel]?c.set(f,s):n.push(i({},s))}else if("controller"===s.type&&64===s.controllerType){var p=s.value>=64;if(!p&&u[s.channel]){var y,d=o(c);try{for(d.s();!(y=d.n()).done;){var I=t(y.value,2),m=I[0],w=I[1];w.channel!==s.channel||a.has(m)||(n.push({deltaTime:s.deltaTime,tick:s.tick,time:s.time,channel:w.channel,noteNumber:w.noteNumber,trackIndex:w.trackIndex,type:"noteOff",velocity:w.velocity}),c.delete(m))}}catch(e){d.e(e)}finally{d.f()}}u[s.channel]=p}else n.push(i({},s))}}catch(e){l.e(e)}finally{l.f()}var v,b=o(c);try{for(b.s();!(v=b.n()).done;){var U=t(v.value,2),g=(U[0],U[1]);n.push(i({},g))}}catch(e){b.e(e)}finally{b.f()}return n}(function(e){var t=[];for(var r in e.tracks){var n,a=0,i=o(e.tracks[r]);try{for(i.s();!(n=i.n()).done;){var c=n.value;a+=c.deltaTime,c.tick=a,c.trackIndex=parseInt(r,10),t.push(c)}}catch(e){i.e(e)}finally{i.f()}}t.sort((function(e,t){return e.tick<t.tick?-1:e.tick>t.tick?1:0}));var u,l=0,s=0,f=120;u=e.header.ticksPerBeat?60/f/e.header.ticksPerBeat:1e6/(e.header.framesPerSecond*e.header.ticksPerFrame);for(var h=0,p=t;h<p.length;h++){var y=p[h],d=y.tick-l;y.time=s+d*u,s=y.time,l=y.tick,"setTempo"===y.type&&(f=6e7/y.microsecondsPerBeat,e.header.ticksPerBeat&&(u=60/f/e.header.ticksPerBeat))}return t}(c)),s=function(e){var r,n=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}).useFullPitchBendRange?w:m,a=[],c={},u={},l={},s={},f=[b,v,U,g],h={},p={},y=o(e);try{for(y.s();!(r=y.n()).done;){var d=r.value;if("controller"===d.type&&121===d.controllerType&&(s[d.channel]=n),"controller"===d.type&&f.includes(d.controllerType)){u[d.channel]||(u[d.channel]={}),u[d.channel][d.controllerType]=d.value;var I=!1;d.controllerType===b&&0===d.value?h[d.channel]=!0:d.controllerType===v&&0===d.value?p[d.channel]=!0:d.controllerType===U&&h[d.channel]?(h[d.channel]=!1,I=!0):d.controllerType===g&&p[d.channel]&&(p[d.channel]=!1,I=!0),I&&0===(u[d.channel][b]||0)&&0===(u[d.channel][v]||0)&&(s[d.channel]=(u[d.channel][U]||n)+(u[d.channel][g]||0)/100)}if("noteOn"===d.type||"noteOff"===d.type){var k=l[d.channel]||0,x=s[d.channel]||n,S=Math.round(k*x),O=d.noteNumber+S;a.push(i(i({},d),{},{noteNumber:O}));var P="".concat(d.trackIndex,"-").concat(d.noteNumber);c[d.channel]||(c[d.channel]=new Map),"noteOn"===d.type?c[d.channel].set(P,d):c[d.channel].delete(P)}else if("pitchBend"===d.type){var M=(l[d.channel]||0)*(s[d.channel]||n);"pitchBend"===d.type&&(l[d.channel]=d.value/8192);var T=(l[d.channel]||0)*(s[d.channel]||n),N=Math.round(M),B=Math.round(T);if(N!==B&&c[d.channel]){var j,V=o(c[d.channel]);try{for(V.s();!(j=V.n()).done;){var E=t(j.value,2),C=(E[0],E[1]);a.push({deltaTime:d.deltaTime,tick:d.tick,time:d.time,channel:C.channel,noteNumber:C.noteNumber+N,trackIndex:C.trackIndex,type:"noteOff",velocity:C.velocity}),a.push({deltaTime:d.deltaTime,tick:d.tick,time:d.time,channel:C.channel,noteNumber:C.noteNumber+B,trackIndex:C.trackIndex,type:"noteOn",velocity:C.velocity})}}catch(e){V.e(e)}finally{V.f()}}}else a.push(i({},d))}}catch(e){y.e(e)}finally{y.f()}return a}(u,n),f=function(e){var t,r=new Map,n=o(e);try{for(n.s();!(t=n.n()).done;){var a=t.value;if("noteOn"===a.type||"noteOff"===a.type){var i="".concat(a.trackIndex,"-").concat(a.channel,"-").concat(a.noteNumber),c=r.get(i)||[];if("noteOn"===a.type)c.push(a),r.set(i,c);else if(c.length>0){var u=c.pop();u.duration=a.time-u.time,0===c.length&&r.delete(i)}}}}catch(e){n.e(e)}finally{n.f()}return e}(s),h=f[f.length-1].time,p=new Map,y={},d=new Map,I=new Map,k=[];function x(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=d.get("".concat(r,"-").concat(t)),a=I.get(r),i=void 0!==n?n:a||0,o="".concat(t,"-").concat(r,"-").concat(i),u=2===(null==c||null===(e=c.header)||void 0===e?void 0:e.format)?9===r||10===r:9===r;if(p.has(o))return p.get(o);var l={name:"",trackIndex:t,channel:r,instrument:i,isPercussion:u,notes:[]};return p.set(o,l),l}var S,O=null,P=o(f);try{for(P.s();!(S=P.n()).done;){var M=S.value;switch(M.type){case"noteOn":x(M.trackIndex,M.channel).notes.push({time:M.time,duration:M.duration,key:M.noteNumber,velocity:M.velocity});break;case"programChange":d.set("".concat(M.channel,"-").concat(M.trackIndex),M.programNumber),I.set(M.channel,M.programNumber);break;case"channelPrefix":O=M.channel;break;case"trackName":void 0===y[M.trackIndex]&&(y[M.trackIndex]={}),y[M.trackIndex][O||0]=M.text.trim();break;case"text":var T=M.text.match(/^@T(.*)$/);T&&k.push(T[1])}}}catch(e){P.e(e)}finally{P.f()}a=k.length>0?k.join(" - ").trim():function(e){return e.replace(/[_]+/g," ").replace(/\.[a-zA-Z0-9]+$/,"").replace(/^(.)|\s+(.)/g,(function(e){return e.toUpperCase()})).trim()}(r);var N=Array.from(p,(function(e){var r=t(e,2);return r[0],r[1]})).filter((function(e){return e.notes.length>0}));N.sort((function(e,t){return 1e6*e.trackIndex+1e3*e.channel+e.instrument<1e6*t.trackIndex+1e3*t.channel+t.instrument?-1:1}));var B,j=o(N);try{for(j.s();!(B=j.n()).done;){var V=B.value;V.name=y[V.trackIndex]&&(y[V.trackIndex][V.channel]||y[V.trackIndex][0])||""}}catch(e){j.e(e)}finally{j.f()}return{title:a,duration:h,tracks:N}}(e,r,n),c="";c+=f,c+=x(a.title),c+=k(I,1),c+=k(Math.ceil(a.duration),3);var u,s=[],S=o(a.tracks);try{for(S.s();!(u=S.n()).done;){var O=u.value,P={};O.isPercussion?P.instrument=O.instrument+128:P.instrument=O.instrument,P.isPercussion=O.isPercussion,P.channel=O.channel+1,P.name=O.name||"";var M,T=0,N=[],B=o(O.notes);try{for(B.s();!(M=B.n()).done;){var j=M.value,V=j.key;if(V>=0&&V<127){for(var E=j.time-T,C=Math.min(j.duration,p),A="";E>d;)A+=k(255,1),E-=d,T+=d;var D=Math.round(E*y),F=D/y,R=Math.max(0,C+E-F),q=Math.floor(R*h),$=q>255&&V<127,_=$?128:0;N.push(A+k(V|_,1)+k(D,2)+k(q,$?2:1))}}}catch(e){B.e(e)}finally{B.f()}P.notes=N,s.push(P)}}catch(e){S.e(e)}finally{S.f()}if(s.length>255)throw"A song cannot have more than 255 tracks.";c+=k(s.length,1);for(var L=0,z=s;L<z.length;L++){var H=z[L];if(H.notes.length>65535)throw"A track cannot have more than 65535 notes.";c+=k(H.instrument,1),c+=k(H.channel,1),c+=k(H.notes.length,2)}for(var Z=0,G=s;Z<G.length;Z++)c+=G[Z].notes.join("");for(var J=0,K=s;J<K.length;J++)c+=x(K[J].name);return c}})(),n})()));
//# sourceMappingURL=musician-midi-converter.js.map