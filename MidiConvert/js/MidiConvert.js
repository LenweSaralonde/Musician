!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.MidiConvert=e():t.MidiConvert=e()}(window,function(){return function(t){var e={};function n(r){if(e[r])return e[r].exports;var i=e[r]={i:r,l:!1,exports:{}};return t[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=t,n.c=e,n.d=function(t,e,r){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)n.d(r,i,function(e){return t[e]}.bind(null,i));return r},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=3)}([function(t,e,n){(function(t){var n={};!function(t){var e=t.DEFAULT_VOLUME=90,n=(t.DEFAULT_DURATION=128,t.DEFAULT_CHANNEL=0,{midi_letter_pitches:{a:21,b:23,c:12,d:14,e:16,f:17,g:19},midiPitchFromNote:function(t){var e=/([a-g])(#+|b+)?([0-9]+)$/i.exec(t),r=e[1].toLowerCase(),i=e[2]||"";return 12*parseInt(e[3],10)+n.midi_letter_pitches[r]+("#"==i.substr(0,1)?1:-1)*i.length},ensureMidiPitch:function(t){return"number"!=typeof t&&/[^0-9]/.test(t)?n.midiPitchFromNote(t):parseInt(t,10)},midi_pitches_letter:{12:"c",13:"c#",14:"d",15:"d#",16:"e",17:"f",18:"f#",19:"g",20:"g#",21:"a",22:"a#",23:"b"},midi_flattened_notes:{"a#":"bb","c#":"db","d#":"eb","f#":"gb","g#":"ab"},noteFromMidiPitch:function(t,e){var r,i=0,a=t;e=e||!1;return t>23&&(a=t-12*(i=Math.floor(t/12)-1)),r=n.midi_pitches_letter[a],e&&r.indexOf("#")>0&&(r=n.midi_flattened_notes[r]),r+i},mpqnFromBpm:function(t){var e=Math.floor(6e7/t),n=[];do{n.unshift(255&e),e>>=8}while(e);for(;n.length<3;)n.push(0);return n},bpmFromMpqn:function(t){if(void 0!==t[0]){0;for(var e=0,n=t.length-1;n>=0;++e,--n)t[e]<<n}return Math.floor(6e7/t)},codes2Str:function(t){return String.fromCharCode.apply(null,t)},str2Bytes:function(t,e){if(e)for(;t.length/2<e;)t="0"+t;for(var n=[],r=t.length-1;r>=0;r-=2){var i=0===r?t[r]:t[r-1]+t[r];n.unshift(parseInt(i,16))}return n},translateTickTime:function(t){for(var e=127&t;t>>=7;)e<<=8,e|=127&t|128;for(var n=[];n.push(255&e),128&e;)e>>=8;return n}}),r=function(t){if(!this)return new r(t);!t||null===t.type&&void 0===t.type||null===t.channel&&void 0===t.channel||null===t.param1&&void 0===t.param1||(this.setTime(t.time),this.setType(t.type),this.setChannel(t.channel),this.setParam1(t.param1),this.setParam2(t.param2))};r.NOTE_OFF=128,r.NOTE_ON=144,r.AFTER_TOUCH=160,r.CONTROLLER=176,r.PROGRAM_CHANGE=192,r.CHANNEL_AFTERTOUCH=208,r.PITCH_BEND=224,r.prototype.setTime=function(t){this.time=n.translateTickTime(t||0)},r.prototype.setType=function(t){if(t<r.NOTE_OFF||t>r.PITCH_BEND)throw new Error("Trying to set an unknown event: "+t);this.type=t},r.prototype.setChannel=function(t){if(t<0||t>15)throw new Error("Channel is out of bounds.");this.channel=t},r.prototype.setParam1=function(t){this.param1=t},r.prototype.setParam2=function(t){this.param2=t},r.prototype.toBytes=function(){var t=[],e=this.type|15&this.channel;return t.push.apply(t,this.time),t.push(e),t.push(this.param1),void 0!==this.param2&&null!==this.param2&&t.push(this.param2),t};var i=function(t){if(!this)return new i(t);this.setTime(t.time),this.setType(t.type),this.setData(t.data)};i.SEQUENCE=0,i.TEXT=1,i.COPYRIGHT=2,i.TRACK_NAME=3,i.INSTRUMENT=4,i.LYRIC=5,i.MARKER=6,i.CUE_POINT=7,i.CHANNEL_PREFIX=32,i.END_OF_TRACK=47,i.TEMPO=81,i.SMPTE=84,i.TIME_SIG=88,i.KEY_SIG=89,i.SEQ_EVENT=127,i.prototype.setTime=function(t){this.time=n.translateTickTime(t||0)},i.prototype.setType=function(t){this.type=t},i.prototype.setData=function(t){this.data=t},i.prototype.toBytes=function(){if(!this.type)throw new Error("Type for meta-event not specified.");var t=[];if(t.push.apply(t,this.time),t.push(255,this.type),Array.isArray(this.data))t.push(this.data.length),t.push.apply(t,this.data);else if("number"==typeof this.data)t.push(1,this.data);else if(null!==this.data&&void 0!==this.data){t.push(this.data.length);var e=this.data.split("").map(function(t){return t.charCodeAt(0)});t.push.apply(t,e)}else t.push(0);return t};var a=function(t){if(!this)return new a(t);var e=t||{};this.events=e.events||[]};a.START_BYTES=[77,84,114,107],a.END_BYTES=[0,255,47,0],a.prototype.addEvent=function(t){return this.events.push(t),this},a.prototype.addNoteOn=a.prototype.noteOn=function(t,i,a,o){return this.events.push(new r({type:r.NOTE_ON,channel:t,param1:n.ensureMidiPitch(i),param2:o||e,time:a||0})),this},a.prototype.addNoteOff=a.prototype.noteOff=function(t,i,a,o){return this.events.push(new r({type:r.NOTE_OFF,channel:t,param1:n.ensureMidiPitch(i),param2:o||e,time:a||0})),this},a.prototype.addNote=a.prototype.note=function(t,e,n,r,i){return this.noteOn(t,e,r,i),n&&this.noteOff(t,e,n,i),this},a.prototype.addChord=a.prototype.chord=function(t,e,n,r){if(!Array.isArray(e)&&!e.length)throw new Error("Chord must be an array of pitches");return e.forEach(function(e){this.noteOn(t,e,0,r)},this),e.forEach(function(e,r){0===r?this.noteOff(t,e,n):this.noteOff(t,e)},this),this},a.prototype.setInstrument=a.prototype.instrument=function(t,e,n){return this.events.push(new r({type:r.PROGRAM_CHANGE,channel:t,param1:e,time:n||0})),this},a.prototype.setTempo=a.prototype.tempo=function(t,e){return this.events.push(new i({type:i.TEMPO,data:n.mpqnFromBpm(t),time:e||0})),this},a.prototype.toBytes=function(){var t=0,e=[],r=a.START_BYTES,i=a.END_BYTES;this.events.forEach(function(n){var r=n.toBytes();t+=r.length,e.push.apply(e,r)}),t+=i.length;var o=n.str2Bytes(t.toString(16),4);return r.concat(o,e,i)};var o=function(t){if(!this)return new o(t);var e=t||{};if(e.ticks){if("number"!=typeof e.ticks)throw new Error("Ticks per beat must be a number!");if(e.ticks<=0||e.ticks>=32768||e.ticks%1!=0)throw new Error("Ticks per beat must be an integer between 1 and 32767!")}this.ticks=e.ticks||128,this.tracks=e.tracks||[]};o.HDR_CHUNKID="MThd",o.HDR_CHUNK_SIZE="\0\0\0",o.HDR_TYPE0="\0\0",o.HDR_TYPE1="\0",o.prototype.addTrack=function(t){return t?(this.tracks.push(t),this):(t=new a,this.tracks.push(t),t)},o.prototype.toBytes=function(){var t=this.tracks.length.toString(16),e=o.HDR_CHUNKID+o.HDR_CHUNK_SIZE;return parseInt(t,16)>1?e+=o.HDR_TYPE1:e+=o.HDR_TYPE0,e+=n.codes2Str(n.str2Bytes(t,2)),e+=String.fromCharCode(this.ticks/256,this.ticks%256),this.tracks.forEach(function(t){e+=n.codes2Str(t.toBytes())}),e},t.Util=n,t.File=o,t.Track=a,t.Event=r,t.MetaEvent=i}(n),null!==t?t.exports=n:null!==e?e=n:this.Midi=n}).call(this,n(2)(t))},function(t,e){function n(t){var e=0;function n(n){var r=t.charCodeAt(e);return n&&r>127&&(r-=256),e+=1,r}return{eof:function(){return e>=t.length},read:function(n){var r=t.substr(e,n);return e+=n,r},readInt32:function(){var n=(t.charCodeAt(e)<<24)+(t.charCodeAt(e+1)<<16)+(t.charCodeAt(e+2)<<8)+t.charCodeAt(e+3);return e+=4,n},readInt16:function(){var n=(t.charCodeAt(e)<<8)+t.charCodeAt(e+1);return e+=2,n},readInt8:n,readVarInt:function(){for(var t=0;;){var e=n();if(!(128&e))return t+e;t+=127&e,t<<=7}}}}t.exports=function(t){return function(t){function e(t){var e=t.read(4),n=t.readInt32();return{id:e,length:n,data:t.read(n)}}var r;function i(t){var e={};e.deltaTime=t.readVarInt();var n,i=t.readInt8();if(240==(240&i)){if(255==i){e.type="meta";var a=t.readInt8(),o=t.readVarInt();switch(a){case 0:if(e.subtype="sequenceNumber",2!=o)throw"Expected length for sequenceNumber event is 2, got "+o;return e.number=t.readInt16(),e;case 1:return e.subtype="text",e.text=t.read(o),e;case 2:return e.subtype="copyrightNotice",e.text=t.read(o),e;case 3:return e.subtype="trackName",e.text=t.read(o),e;case 4:return e.subtype="instrumentName",e.text=t.read(o),e;case 5:return e.subtype="lyrics",e.text=t.read(o),e;case 6:return e.subtype="marker",e.text=t.read(o),e;case 7:return e.subtype="cuePoint",e.text=t.read(o),e;case 32:if(e.subtype="midiChannelPrefix",1!=o)throw"Expected length for midiChannelPrefix event is 1, got "+o;return e.channel=t.readInt8(),e;case 47:if(e.subtype="endOfTrack",0!=o)throw"Expected length for endOfTrack event is 0, got "+o;return e;case 81:if(e.subtype="setTempo",3!=o)throw"Expected length for setTempo event is 3, got "+o;return e.microsecondsPerBeat=(t.readInt8()<<16)+(t.readInt8()<<8)+t.readInt8(),e;case 84:if(e.subtype="smpteOffset",5!=o)throw"Expected length for smpteOffset event is 5, got "+o;var s=t.readInt8();return e.frameRate={0:24,32:25,64:29,96:30}[96&s],e.hour=31&s,e.min=t.readInt8(),e.sec=t.readInt8(),e.frame=t.readInt8(),e.subframe=t.readInt8(),e;case 88:if(e.subtype="timeSignature",4!=o)throw"Expected length for timeSignature event is 4, got "+o;return e.numerator=t.readInt8(),e.denominator=Math.pow(2,t.readInt8()),e.metronome=t.readInt8(),e.thirtyseconds=t.readInt8(),e;case 89:if(e.subtype="keySignature",2!=o)throw"Expected length for keySignature event is 2, got "+o;return e.key=t.readInt8(!0),e.scale=t.readInt8(),e;case 127:return e.subtype="sequencerSpecific",e.data=t.read(o),e;default:return e.subtype="unknown",e.data=t.read(o),e}return e.data=t.read(o),e}if(240==i){e.type="sysEx";var o=t.readVarInt();return e.data=t.read(o),e}if(247==i){e.type="dividedSysEx";var o=t.readVarInt();return e.data=t.read(o),e}throw"Unrecognised MIDI event type byte: "+i}0==(128&i)?(n=i,i=r):(n=t.readInt8(),r=i);var u=i>>4;switch(e.channel=15&i,e.type="channel",u){case 8:return e.subtype="noteOff",e.noteNumber=n,e.velocity=t.readInt8(),e;case 9:return e.noteNumber=n,e.velocity=t.readInt8(),0==e.velocity?e.subtype="noteOff":e.subtype="noteOn",e;case 10:return e.subtype="noteAftertouch",e.noteNumber=n,e.amount=t.readInt8(),e;case 11:return e.subtype="controller",e.controllerType=n,e.value=t.readInt8(),e;case 12:return e.subtype="programChange",e.programNumber=n,e;case 13:return e.subtype="channelAftertouch",e.amount=n,e;case 14:return e.subtype="pitchBend",e.value=n+(t.readInt8()<<7),e;default:throw"Unrecognised MIDI event type: "+u}}stream=n(t);var a=e(stream);if("MThd"!=a.id||6!=a.length)throw"Bad .mid file - header not found";var o=n(a.data),s=o.readInt16(),u=o.readInt16(),c=o.readInt16();if(32768&c)throw"Expressing time division in SMTPE frames is not supported yet";ticksPerBeat=c;for(var h={formatType:s,trackCount:u,ticksPerBeat:ticksPerBeat},f=[],l=0;l<h.trackCount;l++){f[l]=[];var m=e(stream);if("MTrk"!=m.id)throw"Unexpected chunk - expected MTrk, got "+m.id;for(var d=n(m.data);!d.eof();){var p=i(d);f[l].push(p)}}return{header:h,tracks:f}}(t)}},function(t,e){t.exports=function(t){return t.webpackPolyfill||(t.deprecate=function(){},t.paths=[],t.children||(t.children=[]),Object.defineProperty(t,"loaded",{enumerable:!0,get:function(){return t.l}}),Object.defineProperty(t,"id",{enumerable:!0,get:function(){return t.i}}),t.webpackPolyfill=1),t}},function(t,e,n){"use strict";n.r(e);var r=n(1),i=n(0);function a(t){return"number"==typeof t}var o,s=(o=/^([a-g]{1}(?:b|#|x|bb)?)(-?[0-9]+)/i,function(t){return function(t){return"string"==typeof t}(t)&&o.test(t)});var u=function(){var t=/^([a-g]{1}(?:b|#|x|bb)?)(-?[0-9]+)/i,e={cbb:-2,cb:-1,c:0,"c#":1,cx:2,dbb:0,db:1,d:2,"d#":3,dx:4,ebb:2,eb:3,e:4,"e#":5,ex:6,fbb:3,fb:4,f:5,"f#":6,fx:7,gbb:5,gb:6,g:7,"g#":8,gx:9,abb:7,ab:8,a:9,"a#":10,ax:11,bbb:9,bb:10,b:11,"b#":12,bx:13};return function(n){var r=t.exec(n),i=r[1],a=r[2];return e[i.toLowerCase()]+12*(parseInt(a)+1)}}();function c(t,e){if(t.length){var n=function(t,e){var n=0,r=t.length,i=r;if(r>0&&t[r-1].time<=e)return r-1;for(;n<i;){var a=Math.floor(n+(i-n)/2),o=t[a],s=t[a+1];if(o.time===e){for(var u=a;u<t.length;u++)t[u].time===e&&(a=u);return a}if(o.time<e&&s.time>e)return a;o.time>e?i=a:o.time<e&&(n=a+1)}return-1}(t,e.time);t.splice(n+1,0,e)}else t.push(e)}var h=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}();var f={1:"modulationWheel",2:"breath",4:"footController",5:"portamentoTime",7:"volume",8:"balance",10:"pan",64:"sustain",65:"portamentoTime",66:"sostenuto",67:"softPedal",68:"legatoFootswitch",84:"portamentoContro"},l=function(){function t(e,n,r){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:-1;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.number=e,this.time=n,this.value=r,this.channel=i,this.instrument=a}return h(t,[{key:"toJSON",value:function(){return{number:this.number,time:this.time,value:this.value}}},{key:"name",get:function(){if(f.hasOwnProperty(this.number))return f[this.number]}}]),t}(),m=["acoustic grand piano","bright acoustic piano","electric grand piano","honky-tonk piano","electric piano 1","electric piano 2","harpsichord","clavi","celesta","glockenspiel","music box","vibraphone","marimba","xylophone","tubular bells","dulcimer","drawbar organ","percussive organ","rock organ","church organ","reed organ","accordion","harmonica","tango accordion","acoustic guitar (nylon)","acoustic guitar (steel)","electric guitar (jazz)","electric guitar (clean)","electric guitar (muted)","overdriven guitar","distortion guitar","guitar harmonics","acoustic bass","electric bass (finger)","electric bass (pick)","fretless bass","slap bass 1","slap bass 2","synth bass 1","synth bass 2","violin","viola","cello","contrabass","tremolo strings","pizzicato strings","orchestral harp","timpani","string ensemble 1","string ensemble 2","synthstrings 1","synthstrings 2","choir aahs","voice oohs","synth voice","orchestra hit","trumpet","trombone","tuba","muted trumpet","french horn","brass section","synthbrass 1","synthbrass 2","soprano sax","alto sax","tenor sax","baritone sax","oboe","english horn","bassoon","clarinet","piccolo","flute","recorder","pan flute","blown bottle","shakuhachi","whistle","ocarina","lead 1 (square)","lead 2 (sawtooth)","lead 3 (calliope)","lead 4 (chiff)","lead 5 (charang)","lead 6 (voice)","lead 7 (fifths)","lead 8 (bass + lead)","pad 1 (new age)","pad 2 (warm)","pad 3 (polysynth)","pad 4 (choir)","pad 5 (bowed)","pad 6 (metallic)","pad 7 (halo)","pad 8 (sweep)","fx 1 (rain)","fx 2 (soundtrack)","fx 3 (crystal)","fx 4 (atmosphere)","fx 5 (brightness)","fx 6 (goblins)","fx 7 (echoes)","fx 8 (sci-fi)","sitar","banjo","shamisen","koto","kalimba","bag pipe","fiddle","shanai","tinkle bell","agogo","steel drums","woodblock","taiko drum","melodic tom","synth drum","reverse cymbal","guitar fret noise","breath noise","seashore","bird tweet","telephone ring","helicopter","applause","gunshot"],d=["piano","chromatic percussion","organ","guitar","bass","strings","ensemble","brass","reed","pipe","synth lead","synth pad","synth effects","ethnic","percussive","sound effects"],p={0:"standard kit",8:"room kit",16:"power kit",24:"electronic kit",25:"tr-808 kit",32:"jazz kit",40:"brush kit",48:"orchestra kit",56:"sound fx kit"};function y(t,e){for(var n=0;n<t.length;n++){var r=t[n],i=e[n];if(r.length>i)return!0}return!1}function v(t,e,n){for(var r=0,i=1/0,a=0;a<t.length;a++){var o=t[a],s=e[a];o[s]&&o[s].time<i&&(r=a,i=o[s].time)}n[r](t[r][e[r]]),e[r]+=1}var b=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}();var g=function(){function t(e,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,o=arguments[4],u=arguments[5];if(function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),a(e))this.midi=e;else{if(!s(e))throw new Error("the midi value must either be in Pitch Notation (e.g. C#4) or a midi value");this.name=e}this.time=n,this.duration=r,this.velocity=i,this.channel=o,this.instrument=u}return b(t,null,[{key:"fromJSON",value:function(e){return new t(e.midi,e.time,e.duration,e.velocity)}}]),b(t,[{key:"match",value:function(t){return a(t)?this.midi===t:s(t)?this.name.toLowerCase()===t.toLowerCase():void 0}},{key:"toJSON",value:function(){return{name:this.name,midi:this.midi,time:this.time,velocity:this.velocity,duration:this.duration}}},{key:"name",get:function(){return t=this.midi,e=Math.floor(t/12)-1,["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"][t%12]+e;var t,e},set:function(t){this.midi=u(t)}},{key:"noteOn",get:function(){return this.time},set:function(t){this.time=t}},{key:"noteOff",get:function(){return this.time+this.duration},set:function(t){this.duration=t-this.time}}]),t}(),k=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}();var E=function(){function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:-1;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.name=e,this.channelNumber=r,this.notes=[],this.controlChanges={},this.instrumentNumber=n,this.midiType=1}return k(t,null,[{key:"fromJSON",value:function(e){var n=new t(e.name,e.instrumentNumber,e.channelNumber);return n.id=e.id,e.notes&&e.notes.forEach(function(t){var e=g.fromJSON(t);n.notes.push(e)}),e.controlChanges&&(n.controlChanges=e.controlChanges),n}}]),k(t,[{key:"note",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,i=new g(t,e,n,r);return c(this.notes,i),this}},{key:"noteOn",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,r=arguments[3],i=arguments[4],a=new g(t,e,null,n,r,i);return c(this.notes,a),this}},{key:"noteOff",value:function(t,e,n){for(var r=this.notes.length-1;r>=0;r--){var i=this.notes[r];if(i.match(t)&&i.channel===n&&null===i.duration){i.noteOff=e;break}}return this}},{key:"cc",value:function(t,e,n,r,i){this.controlChanges.hasOwnProperty(t)||(this.controlChanges[t]=[]);var a=new l(t,e,n,r,i);return c(this.controlChanges[t],a),this}},{key:"patch",value:function(t){return this.instrumentNumber=t,this}},{key:"channel",value:function(t){return this.channelNumber=t,this}},{key:"scale",value:function(t){return this.notes.forEach(function(e){e.time*=t,e.duration*=t}),this}},{key:"slice",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.duration,r=Math.max(this.notes.findIndex(function(t){return t.time>=e}),0),i=this.notes.findIndex(function(t){return t.noteOff>=n})+1,a=new t(this.name);return a.notes=this.notes.slice(r,i),a.notes.forEach(function(t){return t.time=t.time-e}),a}},{key:"encode",value:function(t,e){var n=e.PPQ/(60/e.bpm),r=0,a=Math.max(0,this.channelNumber);function o(t){var e=Math.floor(n*t),i=Math.max(e-r,0);return r=e,i}-1!==this.instrumentNumber&&t.instrument(a,this.instrumentNumber);var s=Object.keys(this.controlChanges),u=[],c=!0,h=!1,f=void 0;try{for(var l,m=s[Symbol.iterator]();!(c=(l=m.next()).done);c=!0){var d=l.value,p=this.controlChanges[d].sort(function(t,e){return t.time-e.time});u.push(p,function(e){var n=new i.Event({type:i.Event.CONTROLLER,channel:a,param1:e.number,param2:127*e.value,time:o(e.time)});t.events.push(n)})}}catch(t){h=!0,f=t}finally{try{!c&&m.return&&m.return()}finally{if(h)throw f}}(function(){for(var t=arguments.length,e=Array(t),n=0;n<t;n++)e[n]=arguments[n];for(var r=e.filter(function(t,e){return e%2==0}),i=new Uint32Array(r.length),a=e.filter(function(t,e){return e%2==1});y(r,i);)v(r,i,a)}).apply(void 0,[this.noteOns.sort(function(t,e){return t.time-e.time}),function(e){t.addNoteOn(a,e.name,o(e.time),Math.floor(127*e.velocity))},this.noteOffs.sort(function(t,e){return t.time-e.time}),function(e){t.addNoteOff(a,e.name,o(e.time))}].concat(u))}},{key:"toJSON",value:function(){var t=this,e={startTime:this.startTime,duration:this.duration,length:this.length,notes:[],controlChanges:{}};return void 0!==this.id&&(e.id=this.id),e.name=this.name,-1!==this.instrumentNumber&&(e.instrumentNumber=this.instrumentNumber,e.instrument=this.instrument,e.instrumentFamily=this.instrumentFamily),-1!==this.channelNumber&&(e.channelNumber=this.channelNumber,e.isPercussion=this.isPercussion),this.notes.length&&(e.notes=this.notes.map(function(t){return t.toJSON()})),Object.keys(this.controlChanges).length&&(e.controlChanges={},Object.keys(this.controlChanges).forEach(function(n){e.controlChanges[n]=[],t.controlChanges[n].forEach(function(t){return e.controlChanges[n].push(t.toJSON())})})),e}},{key:"noteOns",get:function(){var t=[];return this.notes.forEach(function(e){t.push({time:e.noteOn,midi:e.midi,name:e.name,velocity:e.velocity})}),t}},{key:"noteOffs",get:function(){var t=[];return this.notes.forEach(function(e){t.push({time:e.noteOff,midi:e.midi,name:e.name})}),t}},{key:"length",get:function(){return this.notes.length}},{key:"startTime",get:function(){return this.notes.length?this.notes[0].noteOn:0}},{key:"duration",get:function(){return this.notes.length?this.notes[this.notes.length-1].noteOff:0}},{key:"instrument",get:function(){return this.isPercussion?p[this.instrumentNumber]:m[this.instrumentNumber]},set:function(t){var e=m.indexOf(t);-1!==e&&(this.instrumentNumber=e)}},{key:"isPercussion",get:function(){return 2===this.midiType?[9,10].includes(this.channelNumber):[9].includes(this.channelNumber)}},{key:"instrumentFamily",get:function(){return this.isPercussion?"drums":d[Math.floor(this.instrumentNumber/8)]}}]),t}();var T=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}();var N=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.header={bpm:120,timeSignature:[4,4],PPQ:480},this.tracks=[]}return T(t,null,[{key:"fromJSON",value:function(e){var n=new t;return n.header=e.header,e.tracks.forEach(function(t){var e=E.fromJSON(t);n.tracks.push(e)}),n}}]),T(t,[{key:"load",value:function(t){var e=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"GET";return new Promise(function(i,a){var o=new XMLHttpRequest;o.open(r,t),o.responseType="arraybuffer",o.addEventListener("load",function(){4===o.readyState&&200===o.status?i(e.decode(o.response)):a(o.status)}),o.addEventListener("error",a),o.send(n)}).catch(function(t){console.log(t)})}},{key:"decode",value:function(t){var e=this;if(t instanceof ArrayBuffer){var n=new Uint8Array(t);t=String.fromCharCode.apply(null,n)}var i=r(t);this.header=function(t){for(var e={PPQ:t.header.ticksPerBeat},n=0;n<t.tracks.length;n++)for(var r=t.tracks[n],i=0,a=0;a<r.length;a++){var o=r[a];i+=o.deltaTime,"meta"===o.type&&("timeSignature"===o.subtype?e.timeSignature=[o.numerator,o.denominator]:"setTempo"===o.subtype&&0===i&&(e.bpm||(e.bpm=6e7/o.microsecondsPerBeat)))}return e.bpm=e.bpm||120,e}(i);var a=[{time:0,value:this.header.bpm}],o=[],s=[];i.tracks.forEach(function(t){var n=new E;o.push(n);var r=-1,i=-1,u=0,h=[],f=[];t.forEach(function(t){var o,m;if(u+=(o=t.deltaTime,60/(m=e.header).bpm*(o/m.PPQ)),t.channel&&-1===n.channelNumber&&(n.channelNumber=t.channel),"channel"===t.type&&"controller"===t.subtype&&t.controllerType&&(void 0===h[t.channel]&&(h[t.channel]={}),h[t.channel][t.controllerType]=t.value),"meta"===t.type&&"trackName"===t.subtype)n.name=t.text.replace(/\u0000/g,"");else if("noteOn"===t.subtype)-1===n.channelNumber&&(n.channelNumber=t.channel),r=t.channel,i=void 0===s[r]?-1:s[r],n.noteOn(t.noteNumber,u,t.velocity/127,r,i);else if("noteOff"===t.subtype)n.noteOff(t.noteNumber,u,t.channel);else if("controller"===t.subtype&&t.controllerType)r=t.channel,i=void 0===s[r]?-1:s[r],n.cc(t.controllerType,u,t.value/127,r,i),6===t.controllerType&&h[t.channel]&&!h[t.channel][100]&&0===h[t.channel][101]&&(f[t.channel]=t.value);else if("meta"===t.type&&"instrumentName"===t.subtype){r=t.channel||r;var d=new E;d.channelNumber=r,d.instrument=t.text,i=d.instrumentNumber,-1===n.instrumentNumber&&n.patch(i),s[r]=i}else if("meta"===t.type&&"setTempo"===t.subtype){var p=60/(t.microsecondsPerBeat/1e6),y=new l(null,u,p);c(a,y)}else if("channel"===t.type&&"programChange"===t.subtype)-1===n.instrumentNumber&&n.patch(t.programNumber),i=t.programNumber,r=t.channel,s[r]=i;else if("channel"===t.type&&"pitchBend"===t.subtype){var v=(f[t.channel]||2)*(t.value-8192)/8192;r=t.channel,i=void 0===s[r]?-1:s[r],n.cc(t.subtype,u,v,r,i)}}),e.header.name||n.length||!n.name||(e.header.name=n.name)}),this.tracks=[];var u=0;return o.forEach(function(t){var n=[],r=function(e,r){return void 0===n[e]&&(n[e]=[]),void 0===n[e][r]&&(n[e][r]=new E(t.name,r,e),n[e][r].midiType=i.header.formatType),n[e][r]};t.notes.forEach(function(e){-1===e.channel&&(e.channel=t.channelNumber),-1===e.instrument&&(e.instrument=t.instrumentNumber,-1===e.instrument&&(e.instrument=0)),r(e.channel,e.instrument).notes.push(e)}),Object.keys(t.controlChanges).forEach(function(e){t.controlChanges[e].forEach(function(n){-1===n.channel&&(n.channel=t.channelNumber),-1===n.instrument&&(n.instrument=t.instrumentNumber,-1===n.instrument&&(n.instrument=0));var i=r(n.channel,n.instrument).controlChanges;void 0===i[e]&&(i[e]=[]),i[e].push(n)})}),n.forEach(function(t){t.forEach(function(t){t.id=u,e.tracks.push(t),u++})})}),this.applyTempoChanges(a,this.header.bpm),this}},{key:"encode",value:function(){var t=this,e=new i.File({ticks:this.header.PPQ}),n=this.tracks.filter(function(t){return!t.length})[0];!this.header.name||n&&n.name===this.header.name||e.addTrack().addEvent(new i.MetaEvent({time:0,type:i.MetaEvent.TRACK_NAME,data:this.header.name}));return this.tracks.forEach(function(n){var r=e.addTrack();r.setTempo(t.bpm),n.name&&r.addEvent(new i.MetaEvent({time:0,type:i.MetaEvent.TRACK_NAME,data:n.name})),n.encode(r,t.header)}),e.toBytes()}},{key:"toArray",value:function(){for(var t=this.encode(),e=new Array(t.length),n=0;n<t.length;n++)e[n]=t.charCodeAt(n);return e}},{key:"toJSON",value:function(){var t={header:this.header,startTime:this.startTime,duration:this.duration,tracks:(this.tracks||[]).map(function(t){return t.toJSON()})};return t.header.name||(t.header.name=""),t}},{key:"track",value:function(t){var e=new E(t);return this.tracks.push(e),e}},{key:"get",value:function(t){return a(t)?this.tracks[t]:this.tracks.find(function(e){return e.name===t})}},{key:"slice",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.duration,r=new t;return r.header=this.header,r.tracks=this.tracks.map(function(t){return t.slice(e,n)}),r}},{key:"applyTempoChanges",value:function(t,e){if(0===t.length)return this;var n=function(n){if(0!==n.length){var r=0,i=0,a=0,o=1;n.forEach(function(n){if(!(n.time<t[a].time)){for(r=t[a].time,o=e/t[a].value;t[a+1]&&n.time>=t[a+1].time;)i+=(t[a+1].time-r)*o,r=t[++a].time,o=e/t[a].value;n.time=(n.time-r)*o+i,void 0!==n.duration&&(n.duration*=o)}})}};return this.tracks.forEach(function(t){n(t.notes),Object.keys(t.controlChanges).forEach(function(e){n(t.controlChanges[e])})}),this}},{key:"startTime",get:function(){var t=this.tracks.map(function(t){return t.startTime});return t.length&&Math.min.apply(Math,t)||0}},{key:"bpm",get:function(){return this.header.bpm},set:function(t){var e=this.header.bpm;this.header.bpm=t;var n=e/t;this.tracks.forEach(function(t){return t.scale(n)})}},{key:"timeSignature",get:function(){return this.header.timeSignature},set:function(t){this.header.timeSignature=t}},{key:"duration",get:function(){var t=this.tracks.map(function(t){return t.duration});return t.length&&Math.max.apply(Math,t)||0}}]),t}();function w(t){return(new N).decode(t)}function O(t,e){var n=(new N).load(t);return e&&n.then(e),n}function C(){return new N}function x(t){return N.fromJSON(t)}n.d(e,"parse",function(){return w}),n.d(e,"load",function(){return O}),n.d(e,"create",function(){return C}),n.d(e,"fromJSON",function(){return x}),n.d(e,"instrumentByPatchID",function(){return m}),n.d(e,"instrumentFamilyByID",function(){return d}),n.d(e,"drumKitByPatchID",function(){return p})}])});
//# sourceMappingURL=MidiConvert.js.map